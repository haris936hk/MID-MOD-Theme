{%- doc -%}
  Renders a quick add component.

  @param {object} product - The product object
  @param {string} section_id - The section ID
  @param {object} [block] - The block object
{%- enddoc -%}

{% liquid
  assign product_form_id = 'QuickAdd-ProductForm-' | append: product.id | append: '-' | append: block.id
  assign add_to_cart_text = 'actions.add' | t

  # Logic to determine which variant to use (matching swatch selection logic from product-card)
  assign variant_to_use = product.selected_or_first_available_variant
  assign combined_listing_count = product.options_with_values | map: 'values' | map: 'product_url' | compact | size

  unless combined_listing_count > 0
    assign first_image = product.media.first
    assign variant_images = product.images | where: 'attached_to_variant?', true
    # Get swatchable options (options that have swatch values)
    assign swatch_variant_picker = null
    for option in product.options_with_values
      assign swatch_count = option.values | map: 'swatch' | compact | size
      if swatch_count > 0
        assign swatch_variant_picker = option
        break
      endif
    endfor

    if swatch_variant_picker
      assign swatch_count = swatch_variant_picker.values | map: 'swatch' | compact | size

      if swatch_count == 1
        # Single swatch: use that variant
        assign variant_to_use = swatch_variant_picker.values.first.variant
      elsif swatch_count > 1
        if first_image and variant_images contains first_image
          # First image is a variant image - find which variant it belongs to
          for option_value in swatch_variant_picker.values
            if option_value.variant.featured_media.id == first_image.id
              assign variant_to_use = option_value.variant
              break
            endif
          endfor
        elsif variant_images.size == 0
          # No variants have images - use first swatch variant
          assign variant_to_use = swatch_variant_picker.values.first.variant
        endif
        # else: First image is NOT a variant image - keep default (selected_or_first_available_variant)
      endif
    endif
  endunless

  if variant_to_use.available
    assign can_add_to_cart = true
  else
    assign can_add_to_cart = false
  endif
%}

<quick-add-component
  class="quick-add color-{{ settings.quick_add_color_scheme }} "
  ref="quickAdd"
  data-product-title="{{ product.title }}"
>
  <product-form-component
    data-section-id="{{ section_id }}"
    data-product-id="{{ product.id }}"
    on:submit="/handleSubmit"
    class="
      quick-add__product-form-component
      {% if product.options.size == 1 %} quick-add__product-form-component--single-option {% else %} quick-add__product-form-component--multi-option {% endif %}
      {% if product.variants.size == 1 %} quick-add__product-form-component--single-variant {% else %} quick-add__product-form-component--multi-variant {% endif %}
    "
  >
    <div
      class="visually-hidden"
      aria-live="assertive"
      role="status"
      aria-atomic="true"
      ref="liveRegion"
    ></div>
    {%- form 'product', product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant_to_use.id }}"
        {% if variant_to_use.available == false %}
          disabled
        {% endif %}
      >
      <input
        type="hidden"
        name="quantity"
        value="{% if variant_to_use.quantity_rule.min %}{{ variant_to_use.quantity_rule.min }}{% else %}1{% endif %}"
      >
      {% comment %} If there is one variant option but it's swatches or if it's a single variant product, then use add to cart button {% endcomment %}
      {%- if product.variants.size == 1 or product.options.size == 1 -%}
        {% render 'add-to-cart-button',
          add_to_cart_text: add_to_cart_text,
          class: 'button quick-add__button quick-add__button--add',
          can_add_to_cart: can_add_to_cart,
          icon_only_on_mobile: true,
          product: product
        %}
      {%- endif -%}
      {%- if product.variants.size > 1 -%}
        <button
          class="button quick-add__button quick-add__button--choose"
          {% comment %} type="submit" is the default, so we explicitly set it to "button" to prevent the ProductFormComponent.handleSubmit from being triggered {% endcomment %}
          type="button"
          name="add"
          on:click="quick-add-component/handleClick"
        >
          <span
            class="add-to-cart-text"
          >
            <span
              class="svg-wrapper add-to-cart-icon"
            >
              {{- 'icon-add-to-cart.svg' | inline_asset_content -}}
            </span>
            <span class="add-to-cart-text__content is-visually-hidden-mobile">
              {{ add_to_cart_text }}
            </span>
          </span>
        </button>
      {%- endif -%}
    {%- endform -%}
  </product-form-component>
</quick-add-component>

{% stylesheet %}
  /* Quick Add */
  .quick-add {
    position: absolute;
    bottom: 12px;
    right: 12px;
    display: var(--quick-add-mobile-display, none);
    z-index: var(--layer-raised);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;

    @media screen and (min-width: 750px) {
      display: var(--quick-add-display, flex);
    }
  }

  /* Show quick add on hover for desktop */
  @media screen and (min-width: 750px) {
    .product-card:hover .quick-add,
    .product-card:focus-within .quick-add {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
  }

  /* Always show on mobile when enabled */
  @media screen and (max-width: 749px) {
    .quick-add {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
  }

  .quick-add .variant-option__button-label input[data-option-available='false'] {
    cursor: not-allowed;
  }

  .quick-add[class*='color-scheme-'] {
    background-color: transparent;
  }

  .quick-add__button {
    display: grid;
    padding: 8px 12px;
    align-items: center;
    justify-content: center;
    background-color: var(--color-background);
    color: var(--color-foreground);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    min-width: 44px;
    min-height: 44px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    font-size: 14px;
    font-weight: 500;

    &:hover,
    &:focus {
      background-color: var(--color-foreground);
      color: var(--color-background);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }

    &:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }
  }

  .quick-add__button .add-to-cart-text {
    display: flex;
    align-items: center;
    gap: 6px;
    line-height: 1;
    white-space: nowrap;
  }

  .quick-add__button .add-to-cart-text--added {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .quick-add__button .add-to-cart-text__content {
    @media screen and (max-width: 749px) {
      display: none;
    }
  }

  .quick-add__button.atc-added .add-to-cart-text {
    opacity: 0;
  }

  .quick-add__button.atc-added .add-to-cart-text--added {
    opacity: 1;
    transform: scale(1);
  }

  .quick-add__product-form-component .shopify-product-form {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .quick-add-modal .product-media {
    width: 100%;
    height: 100%;
  }

  .quick-add-modal deferred-media {
    display: none;
  }

  .quick-add-modal .media-gallery--carousel slideshow-component {
    --cursor: default;
  }

{% endstylesheet %}
